# üß™ –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

## –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

1. **PostgreSQL** –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω –Ω–∞ `localhost:5432`
2. **Redis** –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω –Ω–∞ `localhost:6379`
3. **Python 3.13+** —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω

## –ó–∞–ø—É—Å–∫ –±—ç–∫–µ–Ω–¥–∞

```powershell
# –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
.\venv\Scripts\Activate.ps1

# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ (–µ—Å–ª–∏ –µ—â–µ –Ω–µ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã)
alembic upgrade head

# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

–°–µ—Ä–≤–µ—Ä –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ `http://localhost:8000`

---

## –¢–µ—Å—Ç 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ WebSocket

### –®–∞–≥ 1: –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

–û—Ç–∫—Ä–æ–π—Ç–µ `http://localhost:8000/docs` –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:

**POST** `/api/v1/auth/register`
```json
{
  "email": "alice@test.com",
  "password": "password123",
  "display_name": "Alice"
}
```

**–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ** `access_token` –∏–∑ –æ—Ç–≤–µ—Ç–∞.

### –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ

–û—Ç–∫—Ä–æ–π—Ç–µ Console –≤ –±—Ä–∞—É–∑–µ—Ä–µ (F12) –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:

```javascript
const token = "YOUR_ACCESS_TOKEN_HERE";
const ws = new WebSocket(`ws://localhost:8000/ws?token=${token}`);

ws.onopen = () => {
  console.log('‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω!');
};

ws.onerror = (error) => {
  console.error('‚ùå –û—à–∏–±–∫–∞ WebSocket:', error);
};

ws.onmessage = (event) => {
  console.log('üì® –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–±—ã—Ç–∏–µ:', JSON.parse(event.data));
};

ws.onclose = (event) => {
  console.log('üîå WebSocket –∑–∞–∫—Ä—ã—Ç:', event.code, event.reason);
};
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ `WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω!` –ø–æ—è–≤–ª—è–µ—Ç—Å—è –≤ –∫–æ–Ω—Å–æ–ª–∏
- ‚ùå –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –Ω–µ–≤–µ—Ä–Ω—ã–π, —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è —Å –∫–æ–¥–æ–º `1008`

---

## –¢–µ—Å—Ç 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –æ–±–æ–∏–º–∏ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏

### –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞

1. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–≤—É—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (Alice –∏ Bob)
2. –ü–æ–ª—É—á–∏—Ç—å –∏—Ö `access_token`
3. –°–æ–∑–¥–∞—Ç—å –ª–∏—á–Ω—ã–π —á–∞—Ç –º–µ–∂–¥—É –Ω–∏–º–∏

### –°–æ–∑–¥–∞–Ω–∏–µ —á–∞—Ç–∞

**POST** `/api/v1/chats/direct` (–æ—Ç –∏–º–µ–Ω–∏ Alice)
```json
{
  "user_id": 2
}
```
–ì–¥–µ `2` - —ç—Ç–æ `id` –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Bob.

**–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ** `chat_id` –∏–∑ –æ—Ç–≤–µ—Ç–∞.

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—è participants

**–û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å:**
```json
{
  "id": 1,
  "title": "Alice & Bob",
  "is_group": false,
  "created_at": "2024-11-04T...",
  "participants": [
    {
      "id": 1,
      "email": "alice@test.com",
      "display_name": "Alice",
      "tag": "alice",
      ...
    },
    {
      "id": 2,
      "email": "bob@test.com",
      "display_name": "Bob",
      "tag": "bob",
      ...
    }
  ]
}
```

‚úÖ **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–π–¥–µ–Ω–∞**, –µ—Å–ª–∏ –ø–æ–ª–µ `participants` –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –æ–±–æ–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.

### –û—Ç–∫—Ä—ã—Ç—å WebSocket –¥–ª—è –æ–±–æ–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

**–í–∫–ª–∞–¥–∫–∞ 1 (Alice):**
```javascript
const tokenAlice = "ALICE_TOKEN";
const wsAlice = new WebSocket(`ws://localhost:8000/ws?token=${tokenAlice}`);
wsAlice.onmessage = (e) => console.log('üë© Alice –ø–æ–ª—É—á–∏–ª–∞:', JSON.parse(e.data));
wsAlice.onopen = () => console.log('üë© Alice –ø–æ–¥–∫–ª—é—á–µ–Ω–∞');
```

**–í–∫–ª–∞–¥–∫–∞ 2 (Bob):**
```javascript
const tokenBob = "BOB_TOKEN";
const wsBob = new WebSocket(`ws://localhost:8000/ws?token=${tokenBob}`);
wsBob.onmessage = (e) => console.log('üë® Bob –ø–æ–ª—É—á–∏–ª:', JSON.parse(e.data));
wsBob.onopen = () => console.log('üë® Bob –ø–æ–¥–∫–ª—é—á–µ–Ω');
```

### –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è

–ß–µ—Ä–µ–∑ Swagger UI (`/docs`) –∏–ª–∏ —á–µ—Ä–µ–∑ –∫–æ–¥ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:

**POST** `/api/v1/messages` (–æ—Ç –∏–º–µ–Ω–∏ Alice)
```json
{
  "chat_id": 1,
  "type": "text",
  "content": "Hello Bob!"
}
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –í –∫–æ–Ω—Å–æ–ª–∏ Alice –ø–æ—è–≤–ª—è–µ—Ç—Å—è: `Alice –ø–æ–ª—É—á–∏–ª–∞: {event: "message.created", data: {...}}`
- ‚úÖ –í –∫–æ–Ω—Å–æ–ª–∏ Bob **–¢–û–ñ–ï** –ø–æ—è–≤–ª—è–µ—Ç—Å—è: `Bob –ø–æ–ª—É—á–∏–ª: {event: "message.created", data: {...}}`
- ‚úÖ –û–±–∞ –ø–æ–ª—É—á–∞—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º `message.id`

---

## –¢–µ—Å—Ç 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ —Å–æ–±—ã—Ç–∏–π

–ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –∫–æ–Ω—Å–æ–ª–∏ –¥–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è —Å–æ–±—ã—Ç–∏–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ:

```json
{
  "event": "message.created",
  "data": {
    "id": 123,
    "chat_id": 1,
    "author_id": 1,
    "type": "text",
    "content": "Hello Bob!",
    "payload": null,
    "ts": "2024-11-04T14:30:00.123456Z"
  }
}
```

‚úÖ **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–π–¥–µ–Ω–∞**, –µ—Å–ª–∏:
- –ï—Å—Ç—å –ø–æ–ª–µ `event` —Å–æ –∑–Ω–∞—á–µ–Ω–∏–µ–º `"message.created"`
- –ï—Å—Ç—å –ø–æ–ª–µ `data` —Å –ø–æ–ª–Ω—ã–º –æ–±—ä–µ–∫—Ç–æ–º —Å–æ–æ–±—â–µ–Ω–∏—è
- –í—Å–µ –ø–æ–ª—è –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç

---

## –¢–µ—Å—Ç 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ endpoint /users/me

```bash
curl http://localhost:8000/api/v1/users/me \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```json
{
  "id": 1,
  "email": "alice@test.com",
  "display_name": "Alice",
  "tag": "alice",
  "avatar_url": null,
  "created_at": "2024-11-04T10:00:00Z"
}
```

‚úÖ **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–π–¥–µ–Ω–∞**, –µ—Å–ª–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è —Å—Ç–∞—Ç—É—Å `200` —Å –¥–∞–Ω–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

‚ùå **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–≤–∞–ª–µ–Ω–∞**, –µ—Å–ª–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è `401 Unauthorized`.

---

## –¢–µ—Å—Ç 5: –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –∂–∏–∑–Ω–∏ —Ç–æ–∫–µ–Ω–æ–≤

–¢–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–≤ `.env` –∏–ª–∏ `app/core/config.py`):
- `ACCESS_TOKEN_EXPIRE_MINUTES=15` (15 –º–∏–Ω—É—Ç)
- `REFRESH_TOKEN_EXPIRE_MINUTES=10080` (7 –¥–Ω–µ–π)

‚úÖ **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–π–¥–µ–Ω–∞**, –µ—Å–ª–∏ —Ç–æ–∫–µ–Ω—ã –∂–∏–≤—É—Ç –º–∏–Ω–∏–º—É–º 15 –º–∏–Ω—É—Ç.

---

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤

–ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Å–µ—Ä–≤–µ—Ä–∞ —Å —Ñ–ª–∞–≥–æ–º `--reload` –ª–æ–≥–∏ –¥–æ–ª–∂–Ω—ã –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å:

```
INFO:app.api.ws:WebSocket connected: user_id=1
INFO:app.services.message:Broadcast message.created to 2 participants in chat 1
DEBUG:app.services.message:Published message.created to user 1 for message 1
DEBUG:app.services.message:Published message.created to user 2 for message 1
```

---

## –ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### WebSocket –Ω–µ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Ç–æ–∫–µ–Ω –≤–∞–ª–∏–¥–Ω—ã–π
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ Redis –∑–∞–ø—É—â–µ–Ω
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç URL: `ws://` –∞ –Ω–µ `wss://` –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞

### Bob –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
- ‚úÖ –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ WebSocket Bob'–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω (—Å–º–æ—Ç—Ä–∏—Ç–µ `onopen`)
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –æ–±–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —è–≤–ª—è—é—Ç—Å—è —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏ —á–∞—Ç–∞
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞

### –ü–æ–ª–µ participants –ø—É—Å—Ç–æ–µ
- ‚úÖ –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –º–∏–≥—Ä–∞—Ü–∏–∏
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –≤ —Ç–∞–±–ª–∏—Ü–µ `chat_members` –µ—Å—Ç—å –∑–∞–ø–∏—Å–∏
- ‚úÖ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä

---

## –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

```powershell
# –ó–∞–ø—É—Å—Ç–∏—Ç—å pytest —Ç–µ—Å—Ç—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)
pytest tests/

# –ò–ª–∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ —Å–∫—Ä–∏–ø—Ç
python scripts/test_websocket.py
```

---

## –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫

- [ ] WebSocket –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è —Å —Ç–æ–∫–µ–Ω–æ–º
- [ ] WebSocket –æ—Ç–∫–ª–æ–Ω—è–µ—Ç –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π —Ç–æ–∫–µ–Ω
- [ ] –û–±–∞ —É—á–∞—Å—Ç–Ω–∏–∫–∞ –ø–æ–ª—É—á–∞—é—Ç —Å–æ–±—ã—Ç–∏—è –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è
- [ ] –§–æ—Ä–º–∞—Ç —Å–æ–±—ã—Ç–∏–π –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω (`event` + `data`)
- [ ] –ü–æ–ª–µ `participants` –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ –æ—Ç–≤–µ—Ç–∞—Ö API —á–∞—Ç–æ–≤
- [ ] `/users/me` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- [ ] –¢–æ–∫–µ–Ω—ã –∂–∏–≤—É—Ç –º–∏–Ω–∏–º—É–º 15 –º–∏–Ω—É—Ç

---

**–ï—Å–ª–∏ –≤—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ! ‚úÖ**
