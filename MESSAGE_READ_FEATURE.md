# –§—É–Ω–∫—Ü–∏—è "–ü—Ä–æ—á–∏—Ç–∞–Ω–æ" (Message Read Status)

## –î–∞—Ç–∞: 2024-11-04

## –û–ø–∏—Å–∞–Ω–∏–µ

–î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—Ç–ø—Ä–∞–≤–∫–æ–π WebSocket —Å–æ–±—ã—Ç–∏–π.

---

## –ß—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ:

### 1. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

**–¢–∞–±–ª–∏—Ü–∞ `message_reads`**:
- `id` (PK) - ID –∑–∞–ø–∏—Å–∏
- `message_id` (FK) - ID —Å–æ–æ–±—â–µ–Ω–∏—è
- `user_id` (FK) - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `read_at` - –≤—Ä–µ–º—è –ø—Ä–æ—á—Ç–µ–Ω–∏—è
- –£–Ω–∏–∫–∞–ª—å–Ω–æ–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ –ø–∞—Ä—É (message_id, user_id)
- –ò–Ω–¥–µ–∫—Å—ã –Ω–∞ message_id –∏ user_id

### 2. –ú–æ–¥–µ–ª–∏

**`MessageRead`** (`app/domain/models.py`):
- –ú–æ–¥–µ–ª—å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö
- –°–≤—è–∑—å many-to-many –º–µ–∂–¥—É Message –∏ User

### 3. Repository

**`MessageReadRepository`** (`app/repositories/message_read.py`):
- `mark_as_read(message_id, user_id)` - –æ—Ç–º–µ—Ç–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ
- `get_unread_message_ids(chat_id, user_id)` - –ø–æ–ª—É—á–∏—Ç—å ID –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

### 4. Service

**`MessageService`** (`app/services/message.py`):
- `mark_messages_as_read(chat_id, user_id)` - –æ—Ç–º–µ—Ç–∏—Ç—å –≤—Å–µ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç–µ
- `_publish_read_event(chat_id, message_ids)` - –æ—Ç–ø—Ä–∞–≤–∏—Ç—å WebSocket —Å–æ–±—ã—Ç–∏–µ

### 5. API Endpoint

**`POST /api/v1/chats/{chat_id}/read`**

–û—Ç–º–µ—á–∞–µ—Ç –≤—Å–µ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç–µ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

**Request:**
```http
POST /api/v1/chats/6/read
Authorization: Bearer <access_token>
```

**Response (200 OK):**
```json
{
  "message_ids": [57, 58, 59]
}
```

**–û—à–∏–±–∫–∏:**
- `403 Forbidden` - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–º —á–∞—Ç–∞
- `404 Not Found` - —á–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω

### 6. WebSocket Event

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤—Å–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–∞–º —á–∞—Ç–∞ –ø—Ä–∏ –æ—Ç–º–µ—Ç–∫–µ —Å–æ–æ–±—â–µ–Ω–∏–π –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö.

**–§–æ—Ä–º–∞—Ç —Å–æ–±—ã—Ç–∏—è:**
```json
{
  "event": "message.read",
  "data": {
    "chat_id": 6,
    "message_ids": [57, 58, 59]
  }
}
```

---

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ:

### 1. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é

```bash
cd NODUS_s
alembic upgrade head
```

–≠—Ç–æ —Å–æ–∑–¥–∞—Å—Ç —Ç–∞–±–ª–∏—Ü—É `message_reads` –∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∏–Ω–¥–µ–∫—Å—ã.

### 2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä

```bash
# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Ç–µ–∫—É—â–∏–π —Å–µ—Ä–≤–µ—Ä (Ctrl+C)
# –ó–∞–ø—É—Å—Ç–∏—Ç–µ –∑–∞–Ω–æ–≤–æ
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

---

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–º–µ—Ç–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —á–∞—Ç–∞ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

–ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —á–∞—Ç –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è API:

```typescript
// Frontend: src/hooks/useMessages.ts –∏–ª–∏ ChatDetailPage.tsx
useEffect(() => {
  if (chatId) {
    // –û—Ç–º–µ—á–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —á–∞—Ç–∞
    apiAdapter.markChatAsRead(chatId);
  }
}, [chatId]);
```

### –†—É—á–Ω–æ–π –≤—ã–∑–æ–≤ —á–µ—Ä–µ–∑ API

```bash
curl -X POST http://localhost:8000/api/v1/chats/6/read \
  -H "Authorization: Bearer <access_token>"
```

### WebSocket —Å–æ–±—ã—Ç–∏–µ

–ü–æ—Å–ª–µ –≤—ã–∑–æ–≤–∞ endpoint, –≤—Å–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ —á–∞—Ç–∞ –ø–æ–ª—É—á–∞—Ç WebSocket —Å–æ–±—ã—Ç–∏–µ:

```json
{
  "event": "message.read",
  "data": {
    "chat_id": 6,
    "message_ids": [57, 58, 59]
  }
}
```

–§—Ä–æ–Ω—Ç–µ–Ω–¥ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —ç—Ç–æ —Å–æ–±—ã—Ç–∏–µ –∏ –º–µ–Ω—è–µ—Ç —Å—Ç–∞—Ç—É—Å —Å–æ–æ–±—â–µ–Ω–∏–π —Å `delivered` –Ω–∞ `read` (–¥–≤–µ —Å–∏–Ω–∏–µ –≥–∞–ª–æ—á–∫–∏).

---

## –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã:

### 1. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

–°–æ–æ–±—â–µ–Ω–∏–µ —Å—á–∏—Ç–∞–µ—Ç—Å—è –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–º –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –µ—Å–ª–∏:
- ‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç–µ
- ‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –ù–ï –Ω–∞–ø–∏—Å–∞–Ω–æ —ç—Ç–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
- ‚úÖ –ù–µ—Ç –∑–∞–ø–∏—Å–∏ –≤ `message_reads` –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —Å–æ–æ–±—â–µ–Ω–∏—è

### 2. –û—Ç–º–µ—Ç–∫–∞ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ

–ü—Ä–∏ –≤—ã–∑–æ–≤–µ `POST /chats/{chat_id}/read`:
1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –¥–æ—Å—Ç—É–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫ —á–∞—Ç—É
2. –ü–æ–ª—É—á–∞–µ—Ç—Å—è —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
3. –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–æ–∑–¥–∞–µ—Ç—Å—è –∑–∞–ø–∏—Å—å –≤ `message_reads`
4. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è WebSocket —Å–æ–±—ã—Ç–∏–µ `message.read` –≤—Å–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–∞–º
5. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è —Å–ø–∏—Å–æ–∫ ID –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

### 3. WebSocket —Å–æ–±—ã—Ç–∏–µ

–°–æ–±—ã—Ç–∏–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è **–≤—Å–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–∞–º —á–∞—Ç–∞**, –≤–∫–ª—é—á–∞—è:
- –ê–≤—Ç–æ—Ä–∞ —Å–æ–æ–±—â–µ–Ω–∏–π (—á—Ç–æ–±—ã –æ–Ω —É–≤–∏–¥–µ–ª –¥–≤–µ —Å–∏–Ω–∏–µ –≥–∞–ª–æ—á–∫–∏)
- –î—Ä—É–≥–∏—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (–µ—Å–ª–∏ –≥—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç)
- –°–∞–º–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–æ—á–∏—Ç–∞–ª (–¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –º–µ–∂–¥—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏)

---

## –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —á–∞—Ç

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ê –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —á–∞—Ç —Å –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –ë
2. Frontend –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–∑—ã–≤–∞–µ—Ç POST /chats/6/read
3. Backend –Ω–∞—Ö–æ–¥–∏—Ç –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è: [57, 58, 59]
4. Backend —Å–æ–∑–¥–∞–µ—Ç –∑–∞–ø–∏—Å–∏ –≤ message_reads
5. Backend –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç WebSocket —Å–æ–±—ã—Ç–∏–µ –æ–±–æ–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
6. –£ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ë –∏–∫–æ–Ω–∫–∏ –º–µ–Ω—è—é—Ç—Å—è: ‚úì ‚Üí ‚úì‚úì (—Å–∏–Ω–∏–µ)
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ì—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ê –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ ID=60
2. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ë –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —á–∞—Ç
3. POST /chats/6/read –æ—Ç–º–µ—á–∞–µ—Ç [60] –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ –¥–ª—è –ë
4. WebSocket —Å–æ–±—ã—Ç–∏–µ: –≤—Å–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ –≤–∏–¥—è—Ç, —á—Ç–æ –ë –ø—Ä–æ—á–∏—Ç–∞–ª
5. –£ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ê: ‚úì ‚Üí ‚úì‚úì
```

---

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–æ–º:

–§—Ä–æ–Ω—Ç–µ–Ω–¥ —É–∂–µ –≥–æ—Ç–æ–≤! –ù—É–∂–Ω–æ —Ç–æ–ª—å–∫–æ –≤—ã–∑—ã–≤–∞—Ç—å API –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —á–∞—Ç–∞.

### –î–æ–±–∞–≤–∏—Ç—å –≤ ChatDetailPage.tsx:

```typescript
import { useEffect } from 'react';
import { apiAdapter } from '@/lib/apiAdapter';

export const ChatDetailPage = () => {
  const { id } = useParams();
  
  // ... existing code ...
  
  // –û—Ç–º–µ—á–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —á–∞—Ç–∞
  useEffect(() => {
    if (id) {
      apiAdapter.markChatAsRead(Number(id))
        .catch(err => console.error('Failed to mark chat as read:', err));
    }
  }, [id]);
  
  // ... rest of the code ...
};
```

### –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ –≤ apiAdapter.ts:

```typescript
async markChatAsRead(chatId: number): Promise<{message_ids: number[]}> {
  const response = await this.http.post(`/chats/${chatId}/read`);
  return response.data;
}
```

---

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:

### 1. –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é

```bash
alembic upgrade head
```

–û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥:
```
INFO  [alembic.runtime.migration] Running upgrade 20241104_0002 -> 20241104_0003, add message reads
```

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É

```sql
\d message_reads

-- –î–æ–ª–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å:
-- id, message_id, user_id, read_at
-- –ò–Ω–¥–µ–∫—Å—ã –∏ constraints
```

### 3. –¢–µ—Å—Ç API

```bash
# –í–æ–π—Ç–∏ –∫–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
TOKEN="..."

# –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
curl -X POST http://localhost:8000/api/v1/messages \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -H "Idempotency-Key: $(uuidgen)" \
  -d '{"chat_id": 6, "type": "text", "content": "Test message"}'

# –û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ (–æ—Ç –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
curl -X POST http://localhost:8000/api/v1/chats/6/read \
  -H "Authorization: Bearer $OTHER_TOKEN"

# –î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å: {"message_ids": [ID]}
```

### 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å WebSocket

–û—Ç–∫—Ä–æ–π—Ç–µ –¥–≤–∞ –æ–∫–Ω–∞ –±—Ä–∞—É–∑–µ—Ä–∞:
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ê –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ
2. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ë –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —á–∞—Ç
3. –£ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ê –¥–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è –¥–≤–µ —Å–∏–Ω–∏–µ –≥–∞–ª–æ—á–∫–∏ ‚úì‚úì

–í –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ê:
```
üì® Raw WebSocket event received: {event: "message.read", data: {...}}
üìñ handleReadReceipt called: {chatId: 6, messageIds: [60]}
‚úÖ Marking message as read: 60
```

---

## –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:

### –î–ª—è –±–æ–ª—å—à–∏—Ö —á–∞—Ç–æ–≤

–ï—Å–ª–∏ –≤ —á–∞—Ç–µ —Ç—ã—Å—è—á–∏ —Å–æ–æ–±—â–µ–Ω–∏–π, –º–æ–∂–Ω–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å:

```python
# –í MessageReadRepository.get_unread_message_ids
# –î–æ–±–∞–≤–∏—Ç—å –ª–∏–º–∏—Ç –ø–æ—Å–ª–µ–¥–Ω–∏—Ö N —Å–æ–æ–±—â–µ–Ω–∏–π:

stmt = select(Message.id).where(
    Message.chat_id == chat_id,
    Message.author_id != user_id,
    Message.id.not_in(select(read_subquery))
).order_by(Message.ts.desc()).limit(100)  # –ü–æ—Å–ª–µ–¥–Ω–∏–µ 100 —Å–æ–æ–±—â–µ–Ω–∏–π
```

### –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ

–î–ª—è –æ—á–µ–Ω—å –∞–∫—Ç–∏–≤–Ω—ã—Ö —á–∞—Ç–æ–≤ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å Redis –∫—ç—à:

```python
# –í MessageService.mark_messages_as_read
# –ö—ç—à–∏—Ä–æ–≤–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
await redis.set(f"unread:{chat_id}:{user_id}", 0, ex=3600)
```

---

## –§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã:

1. **NEW**: `alembic/versions/20241104_0003_add_message_reads.py` - –º–∏–≥—Ä–∞—Ü–∏—è
2. **NEW**: `app/repositories/message_read.py` - repository
3. **MODIFIED**: `app/domain/models.py` - –¥–æ–±–∞–≤–ª–µ–Ω–∞ –º–æ–¥–µ–ª—å MessageRead
4. **MODIFIED**: `app/services/message.py` - –¥–æ–±–∞–≤–ª–µ–Ω—ã –º–µ—Ç–æ–¥—ã mark_messages_as_read –∏ _publish_read_event
5. **MODIFIED**: `app/api/v1/chats.py` - –¥–æ–±–∞–≤–ª–µ–Ω endpoint POST /{chat_id}/read
6. **NEW**: `MESSAGE_READ_FEATURE.md` - —ç—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

---

## –ì–æ—Ç–æ–≤–æ! üéâ

–§—É–Ω–∫—Ü–∏—è "–ü—Ä–æ—á–∏—Ç–∞–Ω–æ" –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –Ω–∞ –±—ç–∫–µ–Ω–¥–µ –∏ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞ —Å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–æ–º —á–µ—Ä–µ–∑ WebSocket.

**–ß—Ç–æ –¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ:**
1. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é: `alembic upgrade head`
2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä
3. –î–æ–±–∞–≤–∏—Ç—å –≤—ã–∑–æ–≤ `apiAdapter.markChatAsRead()` –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —á–∞—Ç–∞
4. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å! –î–≤–µ —Å–∏–Ω–∏–µ –≥–∞–ª–æ—á–∫–∏ –¥–æ–ª–∂–Ω—ã –ø–æ—è–≤–ª—è—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ ‚úì‚úì
