# –°—Ç–∞—Ç—É—Å —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –ë–î

## –î–∞—Ç–∞: 2024-11-04

## –ü—Ä–æ–±–ª–µ–º–∞:

–ü—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å—Ç–∞—Ç—É—Å—ã —Å–æ–æ–±—â–µ–Ω–∏–π (pending, delivered, read) –ø—Ä–æ–ø–∞–¥–∞–ª–∏, –ø–æ—Ç–æ–º—É —á—Ç–æ —Ö—Ä–∞–Ω–∏–ª–∏—Å—å —Ç–æ–ª—å–∫–æ –≤ –ø–∞–º—è—Ç–∏ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞.

## –†–µ—à–µ–Ω–∏–µ:

–î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `status` –≤ —Ç–∞–±–ª–∏—Ü—É `messages` –¥–ª—è –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –Ω–∞ –±—ç–∫–µ–Ω–¥–µ.

---

## –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ë–î:

### –ù–æ–≤–æ–µ –ø–æ–ª–µ –≤ —Ç–∞–±–ª–∏—Ü–µ `messages`:

```sql
ALTER TABLE messages ADD COLUMN status VARCHAR(20) NOT NULL DEFAULT 'delivered';
CREATE INDEX ix_messages_status ON messages (status);
```

### –í–æ–∑–º–æ–∂–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è status:

- `delivered` - —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏)
- `read` - —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–æ—á–∏—Ç–∞–Ω–æ –≤—Å–µ–º–∏ –ø–æ–ª—É—á–∞—Ç–µ–ª—è–º–∏

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –°—Ç–∞—Ç—É—Å `pending` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ (–æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ)

---

## –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã:

### 1. –°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è

```python
# –ü—Ä–∏ –≤—ã–∑–æ–≤–µ POST /messages
message = Message(...)
message.status = "delivered"  # –°—Ä–∞–∑—É —Å—Ç–∞–≤–∏–º delivered
```

### 2. –û—Ç–º–µ—Ç–∫–∞ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ

```python
# –ü—Ä–∏ –≤—ã–∑–æ–≤–µ POST /chats/{chat_id}/read

# –®–∞–≥ 1: –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å–∏ –≤ message_reads
for message_id in unread_message_ids:
    MessageRead(message_id=message_id, user_id=user_id)

# –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø—Ä–æ—á–∏—Ç–∞–ª–∏ –ª–∏ –í–°–ï —É—á–∞—Å—Ç–Ω–∏–∫–∏
for message in messages:
    read_count = count(message_reads where message_id = message.id)
    expected_reads = total_participants - 1  # –ú–∏–Ω—É—Å –∞–≤—Ç–æ—Ä
    
    if read_count >= expected_reads:
        message.status = "read"  # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ –ë–î
```

### 3. –í–æ–∑–≤—Ä–∞—Ç —á–µ—Ä–µ–∑ API

```python
# GET /messages?chat_id=X
messages = [
    {
        "id": 1,
        "content": "Hello",
        "status": "delivered",  # –°—Ç–∞—Ç—É—Å –∏–∑ –ë–î
        ...
    },
    {
        "id": 2,
        "content": "Hi!",
        "status": "read",  # –°—Ç–∞—Ç—É—Å –∏–∑ –ë–î
        ...
    }
]
```

### 4. WebSocket —Å–æ–±—ã—Ç–∏—è

```json
{
  "event": "message.created",
  "data": {
    "id": 123,
    "content": "New message",
    "status": "delivered",  // –°—Ç–∞—Ç—É—Å –∏–∑ –ë–î
    ...
  }
}
```

---

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞:

### –î–æ (—Å—Ç–∞—Ç—É—Å —Ç–æ–ª—å–∫–æ –≤ –ø–∞–º—è—Ç–∏ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞):
- ‚ùå –°—Ç–∞—Ç—É—Å—ã –ø—Ä–æ–ø–∞–¥–∞—é—Ç –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ
- ‚ùå –†–∞–∑–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –≤–∏–¥—è—Ç —Ä–∞–∑–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã
- ‚ùå –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏

### –ü–æ—Å–ª–µ (—Å—Ç–∞—Ç—É—Å –≤ –ë–î):
- ‚úÖ –°—Ç–∞—Ç—É—Å—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –Ω–∞–≤—Å–µ–≥–¥–∞
- ‚úÖ –í—Å–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –≤–∏–¥—è—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ —Å—Ç–∞—Ç—É—Å—ã
- ‚úÖ –ú–æ–∂–Ω–æ –¥–µ–ª–∞—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫—É –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º
- ‚úÖ –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

---

## –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏:

```bash
cd c:\Codes\Git\NODUS_s

# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
alembic upgrade head

# –û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥:
# INFO  [alembic.runtime.migration] Running upgrade 20241104_0003 -> 20241104_0004, add message status
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞:

```sql
-- –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ –ë–î
psql -U postgres -d nodus

-- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–∞–±–ª–∏—Ü—ã
\d messages

-- –î–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–ª–µ:
-- status | character varying(20) | not null | default 'delivered'

-- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω–¥–µ–∫—Å
\di ix_messages_status

-- –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ API
-- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å
SELECT id, content, status FROM messages ORDER BY ts DESC LIMIT 5;

-- –î–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å:
-- id |  content  |  status   
-----+-----------+-----------
--  1 | Hello     | delivered
--  2 | Read it   | read
```

---

## –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π:

```sql
-- –í—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∞—Ç —Å—Ç–∞—Ç—É—Å 'delivered'
-- –±–ª–∞–≥–æ–¥–∞—Ä—è DEFAULT 'delivered'

-- –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ message_reads:
UPDATE messages m
SET status = 'read'
WHERE EXISTS (
    SELECT 1 
    FROM message_reads mr 
    WHERE mr.message_id = m.id
);
```

---

## –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ API:

### Response —Ç–µ–ø–µ—Ä—å –≤–∫–ª—é—á–∞–µ—Ç status:

**GET /api/v1/messages?chat_id=6**

```json
[
  {
    "id": 57,
    "chat_id": 6,
    "author_id": 3,
    "type": "text",
    "content": "Hello!",
    "payload": null,
    "status": "delivered",  // ‚Üê –ù–û–í–û–ï –ü–û–õ–ï
    "ts": "2024-11-04T10:00:00Z"
  },
  {
    "id": 58,
    "chat_id": 6,
    "author_id": 2,
    "type": "text",
    "content": "Hi there!",
    "payload": null,
    "status": "read",  // ‚Üê –ù–û–í–û–ï –ü–û–õ–ï
    "ts": "2024-11-04T10:01:00Z"
  }
]
```

**POST /api/v1/messages**

Response:
```json
{
  "id": 59,
  "chat_id": 6,
  "author_id": 3,
  "type": "text",
  "content": "New message",
  "payload": null,
  "status": "delivered",  // ‚Üê –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è
  "ts": "2024-11-04T10:05:00Z"
}
```

---

## WebSocket —Å–æ–±—ã—Ç–∏—è:

### message.created

```json
{
  "event": "message.created",
  "data": {
    "id": 60,
    "chat_id": 6,
    "author_id": 3,
    "type": "text",
    "content": "WebSocket test",
    "payload": null,
    "status": "delivered",  // ‚Üê –ò–∑ –ë–î
    "ts": "2024-11-04T10:10:00Z"
  }
}
```

### message.read

```json
{
  "event": "message.read",
  "data": {
    "chat_id": 6,
    "message_ids": [57, 58, 59]
  }
}
```

–ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è —ç—Ç–æ–≥–æ —Å–æ–±—ã—Ç–∏—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –º–æ–∂–µ—Ç:
1. –õ–æ–∫–∞–ª—å–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å—ã –Ω–∞ `read`
2. –ò–ª–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ API (–æ–Ω–∏ —É–∂–µ –±—É–¥—É—Ç —Å `status: "read"`)

---

## –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:

### –ë—ç–∫–µ–Ω–¥:

**–ù–û–í–´–ï:**
- `alembic/versions/20241104_0004_add_message_status.py` - –º–∏–≥—Ä–∞—Ü–∏—è

**–ò–ó–ú–ï–ù–ï–ù–´:**
- `app/domain/models.py` - –¥–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `status` –≤ `Message`
- `app/schemas/message.py` - –¥–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `status` –≤ `MessageRead`
- `app/services/message.py`:
  - `create_message()` - —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç `status = "delivered"`
  - `mark_messages_as_read()` - –æ–±–Ω–æ–≤–ª—è–µ—Ç `status = "read"` –≤ –ë–î
  - `_publish_event()` - –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `status` –≤ WebSocket

### –§—Ä–æ–Ω—Ç–µ–Ω–¥:

**–ò–ó–ú–ï–ù–ï–ù–´:**
- `src/hooks/useMessages.ts` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç–∞—Ç—É—Å –∏–∑ API response
- `src/hooks/useRealtimeSubscriptions.ts` - –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã

**–ù–ï –ò–ó–ú–ï–ù–ï–ù–´ (—Ä–∞–±–æ—Ç–∞—é—Ç –∫–∞–∫ —Ä–∞–Ω—å—à–µ):**
- `src/components/MessageStatus.tsx` - –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∫–æ–Ω–æ–∫
- `src/components/ChatBubble.tsx` - —Ä–µ–Ω–¥–µ—Ä —Å—Ç–∞—Ç—É—Å–∞
- `src/pages/ChatDetailPage.tsx` - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–º–µ—Ç–∫–∞ –ø—Ä–æ—á—Ç–µ–Ω–∏—è

---

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:

### 1. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
```bash
alembic upgrade head
```

### 2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±—ç–∫–µ–Ω–¥
```bash
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

### 3. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥
–ù–∞–∂–º–∏—Ç–µ Ctrl+Shift+R –≤ –±—Ä–∞—É–∑–µ—Ä–µ

### 4. –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:
```
üì§ Sending message (onMutate): "Test"
‚ú® Created optimistic message: {status: "pending"}
üåê API response from sendMessage: {id: 61, status: "delivered"}  ‚Üê –ò–∑ –ë–î!
üì¶ Message with status from backend: {id: 61, status: "delivered"}
```

### 5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ë–î

```sql
SELECT id, content, status FROM messages ORDER BY ts DESC LIMIT 1;
-- id |  content  |  status   
-----+-----------+-----------
-- 61 | Test      | delivered
```

### 6. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É

–°—Ç–∞—Ç—É—Å –¥–æ–ª–∂–µ–Ω –æ—Å—Ç–∞—Ç—å—Å—è! ‚úÖ

```
üìù Raw messages from cache: [{id: 61, status: "delivered"}]  ‚Üê –ó–∞–≥—Ä—É–∂–µ–Ω–æ –∏–∑ API!
üé® Rendering ChatBubble: {id: 61, status: "delivered"}  ‚Üê –°—Ç–∞—Ç—É—Å –µ—Å—Ç—å!
```

### 7. –û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç –Ω–∞ –¥—Ä—É–≥–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ

–°—Ç–∞—Ç—É—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ç–∞–∫–∏–º –∂–µ! ‚úÖ

---

## –û—Ç–ª–∞–¥–∫–∞:

### –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å—ã –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è:

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é:
```bash
alembic current
# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: 20241104_0004
```

2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–∞–±–ª–∏—Ü—É:
```sql
\d messages
-- –î–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–ª–µ status
```

3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ API response:
```bash
curl http://localhost:8000/api/v1/messages?chat_id=6 \
  -H "Authorization: Bearer $TOKEN" | jq '.[0].status'
# –î–æ–ª–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å: "delivered" –∏–ª–∏ "read"
```

### –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å—ã –ø—Ä–æ–ø–∞–¥–∞—é—Ç –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ:

–≠—Ç–æ **–Ω–µ –¥–æ–ª–∂–Ω–æ** –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å! –°—Ç–∞—Ç—É—Å—ã —Ç–µ–ø–µ—Ä—å –≤ –ë–î.

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:
1. –§—Ä–æ–Ω—Ç–µ–Ω–¥ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç–∞—Ç—É—Å –∏–∑ API:
```javascript
console.log('API response:', message);
// –î–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å: {status: "delivered"}
```

2. –ö—ç—à React Query –Ω–µ –∑–∞—Ç–∏—Ä–∞–µ—Ç —Å—Ç–∞—Ç—É—Å:
```javascript
console.log('Cached message:', cachedMessage);
// –î–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å: {status: "delivered"}
```

---

## –ì–æ—Ç–æ–≤–æ! üéâ

–¢–µ–ø–µ—Ä—å —Å—Ç–∞—Ç—É—Å—ã —Å–æ–æ–±—â–µ–Ω–∏–π:
- ‚úÖ –•—Ä–∞–Ω—è—Ç—Å—è –≤ –ë–î –Ω–∞–≤—Å–µ–≥–¥–∞
- ‚úÖ –ù–µ –ø—Ä–æ–ø–∞–¥–∞—é—Ç –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ
- ‚úÖ –û–¥–∏–Ω–∞–∫–æ–≤—ã–µ –Ω–∞ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
- ‚úÖ –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã–µ –∏ –Ω–∞–¥–µ–∂–Ω—ã–µ

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å—Ç–∞–ª–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π!** üöÄ
